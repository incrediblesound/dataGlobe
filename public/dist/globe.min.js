/*! dataGlobe 2014-09-26 */
function Graph(a){this.options=a||{},this.nodeSet={},this.nodes=[],this.edges=[],this.layout}function Node(a){this.id=a,this.nodesTo=[],this.nodesFrom=[],this.position={},this.data={}}function Edge(a,b){this.source=a,this.target=b,this.data={}}Graph.prototype.addNode=function(a){return void 0!=this.nodeSet[a.id]||this.reached_limit()?!1:(this.nodeSet[a.id]=a,this.nodes.push(a),!0)},Graph.prototype.getNode=function(a){return this.nodeSet[a]},Graph.prototype.addEdge=function(a,b){if(a.addConnectedTo(b)===!0){var c=new Edge(a,b);return this.edges.push(c),!0}return!1},Graph.prototype.reached_limit=function(){return void 0!=this.options.limit?this.options.limit<=this.nodes.length:!1},Node.prototype.addConnectedTo=function(a){return this.connectedTo(a)===!1?(this.nodesTo.push(a),!0):!1},Node.prototype.connectedTo=function(a){for(var b=0;b<this.nodesTo.length;b++){var c=this.nodesTo[b];if(c.id==a.id)return!0}return!1},THREE.Label=function(a,b){function c(){var b=d.getContext("2d"),c="40pt";b.font=c+" Arial";var e=b.measureText(a).width;d.setAttribute("width",e),b.font=c+" Arial",b.textBaseline="top",b.fillText(a,0,0);var f=new THREE.CubeGeometry(e,200,0),g=new THREE.MeshBasicMaterial({map:new THREE.Texture(d),transparent:!0});g.map.needsUpdate=!0;var h=new THREE.Mesh(f,g);return h}var d=document.createElement("canvas");return c()},THREE.ObjectSelection=function(a){function b(a){g.x=a.clientX/window.innerWidth*2-1,g.y=2*-(a.clientY/window.innerHeight)+1}function c(){d.INTERSECTED&&"function"==typeof f&&f(d.INTERSECTED)}var a=a||{};this.domElement=a.domElement||document,this.projector=new THREE.Projector,this.INTERSECTED;var d=this,e=a.selected,f=a.clicked,g={x:0,y:0};this.domElement.addEventListener("mousemove",b,!1),this.domElement.addEventListener("click",c,!1),this.render=function(a,b){var c=new THREE.Vector3(g.x,g.y,.5);this.projector.unprojectVector(c,b);var d=new THREE.Raycaster(b.position,c.sub(b.position).normalize()),f=d.intersectObject(a,!0);f.length>0?this.INTERSECTED!=f[0].object&&(this.INTERSECTED&&this.INTERSECTED.material.color.setHex(this.INTERSECTED.currentHex),this.INTERSECTED=f[0].object,this.INTERSECTED.currentHex=this.INTERSECTED.material.color.getHex(),this.INTERSECTED.material.color.setHex(16711680),"function"==typeof e&&e(this.INTERSECTED)):(this.INTERSECTED&&this.INTERSECTED.material.color.setHex(this.INTERSECTED.currentHex),this.INTERSECTED=null,"function"==typeof e&&e(this.INTERSECTED))}};var Drawing=Drawing||{};Drawing.SphereGraph=function(a){function b(){j=new THREE.WebGLRenderer({alpha:!0}),j.setSize(window.innerWidth,window.innerHeight),g=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,1e5),g.position.z=2e4,h=new THREE.OrbitControls(g),h.addEventListener("change",f),i=new THREE.Scene;var a=new THREE.SpotLight(10066329);a.position.set(1e4,100,1e3);var b=new THREE.AmbientLight(16777215),c=new THREE.SphereGeometry(o,40,30),d=new THREE.MeshPhongMaterial;d.map=THREE.ImageUtils.loadTexture("./img/world.jpg"),d.normalMap=THREE.ImageUtils.loadTexture("./img/earth_normal.jpg"),d.bumpScale=.05,d.specularMap=THREE.ImageUtils.loadTexture("./img/earth_specular.jpg"),d.specular=new THREE.Color(4473924);var e=new THREE.CubeGeometry(5e4,5e4,5e4),m=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture("./img/stars.jpg"),side:THREE.BackSide}),n=new THREE.Mesh(e,m);i.add(n),globe=new THREE.Mesh(c,d),globe.rotation.y=Math.PI,i.add(globe),i.add(a),i.add(b),k=new THREE.SphereGeometry(50,25,0),t.selection&&(l=new THREE.ObjectSelection({domElement:j.domElement,selected:function(a){null!=a?info_text.select="Object "+a.id:delete info_text.select}})),document.body.appendChild(j.domElement)}function c(a){var b=(90-a.position.x)*Math.PI/180,c=(180-a.position.y)*Math.PI/180;a.position.x=o*Math.sin(b)*Math.cos(c),a.position.y=o*Math.cos(b),a.position.z=o*Math.sin(b)*Math.sin(c);var d=new THREE.Geometry,e=new THREE.LineBasicMaterial({color:"white",linewidth:1});d.vertices.push(new THREE.Vector3(0*a.position.x,0*a.position.y,0*a.position.z)),d.vertices.push(new THREE.Vector3(1.05*a.position.x,1.05*a.position.y,1.05*a.position.z));var f=new THREE.Line(d,e);f.id=a.id,a.data.draw_object=f,a.layout={},a.layout.max_X=90,a.layout.min_X=-90,a.layout.max_Y=180,a.layout.min_Y=-180,a.data.draw_object.lookAt(i.position),i.add(a.data.draw_object)}function d(a,b,c,d){d=d||!1;var e=(u(a.position,b.position),2);material=new THREE.LineBasicMaterial({color:13421772,opacity:.5,linewidth:1});var f=a.position,g=b.position,h=(f.x+g.x)/2,j=(f.y+g.y)/2,k=(f.z+g.z)/2,l=(Math.abs(f.x-g.x),Math.abs(f.y-g.y),[h*e,j*e,k*e]),m=new THREE.QuadraticBezierCurve3(new THREE.Vector3(f.x,f.y,f.z),new THREE.Vector3(l[0],l[1],l[2]),new THREE.Vector3(g.x,g.y,g.z)),n=new THREE.CurvePath;n.add(m);var o=new THREE.LineBasicMaterial({color:c,linewidth:2,transparent:!0});curvedLine=new THREE.Line(n.createPointsGeometry(100),o),curvedLine.lookAt(i.position),d&&(curvedLine.material.transparent=!0,createjs.Tween.get(curvedLine.material).wait(4e3).to({opacity:0},5e3),console.log(curvedLine)),i.add(curvedLine)}function e(){requestAnimationFrame(e),h.update(),f()}function f(){m.layout&&(m.layout.finished||m.layout.generate());for(var a=0;a<n.length;a++)n[a].verticesNeedUpdate=!0;for(var a=0;a<m.nodes.length;a++);t.selection&&l.render(i,g),j.render(i,g)}{var a=a||{};({earth:{uniforms:{texture:{type:"t",value:null}},vertexShader:["varying vec3 vNormal;","varying vec2 vUv;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","vUv = uv;","}"].join("\n"),fragmentShader:["uniform sampler2D texture;","varying vec3 vNormal;","varying vec2 vUv;","void main() {","vec3 diffuse = texture2D( texture, vUv ).xyz;","float intensity = 1.05 - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) );","vec3 atmosphere = vec3( 1.0, 1.0, 1.0 ) * pow( intensity, 3.0 );","gl_FragColor = vec4( diffuse + atmosphere, 1.0 );","}"].join("\n")},atmosphere:{uniforms:{},vertexShader:["varying vec3 vNormal;","void main() {","vNormal = normalize( normalMatrix * normal );","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec3 vNormal;","void main() {","float intensity = pow( 0.8 - dot( vNormal, vec3( 0, 0, 1.0 ) ), 12.0 );","gl_FragColor = vec4( 1.0, 1.0, 1.0, 1.0 ) * intensity;","}"].join("\n")}})}this.layout=a.layout||"2d",this.show_stats=a.showStats||!1,this.show_info=a.showInfo||!0,this.selection=a.selection||!1,this.limit=a.limit||10;var g,h,i,j,k,l,m=new Graph,n=[],o=4900,p=1e4,q=1e4,r=1e4,s=1e4,t=this;b(),e(),this.nodes=[],this.userNode,this.previousNode,this.addEdge=function(a,b){console.log(a),console.log(b);var c=m.getNode(a),e=m.getNode(b);m.addEdge(c,e)&&d(c,e,"red")},this.goToNode=function(a){var b=m.getNode(a),c=2.2*b.position.x,e=2.2*b.position.y,f=2.2*b.position.z;createjs.Tween.get(g.position).to({x:c,y:e,z:f},600),g.lookAt(i.position),this.previousNode&&m.addEdge(b,this.previousNode)&&d(b,this.previousNode,"red",!0),this.previousNode=b},this.getCurrent=function(){return this.previousNode},this.getNode=function(a){return m.getNode(a)},this.createGraph=function(a){if(null!==a.longitude&&null!==a.latitude){var b=new Node(a.fbId);b.position.x=a.latitude,b.position.y=a.longitude,b.data.name=a.name,m.addNode(b),c(b),this.nodes.push(b)}},this.createLayout=function(){var a={};a.width=2e3,a.height=2e3,a.iterations=1e5,a.layout="3d",a.positionUpdated=function(a){p=Math.max(p,a.position.x),q=Math.min(q,a.position.x),r=Math.max(r,a.position.y),s=Math.min(s,a.position.y),a.data.draw_object.position.x=Math.random()*p,a.data.draw_object.position.y=Math.random()*r,a.data.draw_object.position.z=Math.random()*p},m.layout=new Layout.ForceDirected(m,a),m.layout.init(),m.layout.generate()};var u=function(a,b){var c=a.x,d=a.y,e=b.x,f=b.y,g=4900,h=c.toRadians(),i=e.toRadians(),j=(e-c).toRadians(),k=(f-d).toRadians(),a=Math.sin(j/2)*Math.sin(j/2)+Math.cos(h)*Math.cos(i)*Math.sin(k/2)*Math.sin(k/2),l=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),m=g*l;return Math.round(m)};Number.prototype.toRadians=function(){return this*Math.PI/180},this.addUser=function(a,b){b=b||!1;var e=new Node(a.fbId);if(e.position.x=a.latitude,e.position.y=a.longitude,m.addNode(e),c(e),this.userNode=e,b)for(var f,g=0;g<m.nodes.length;g++)f=m.nodes[g],m.addEdge(this.userNode,f)&&d(this.userNode,f,"blue")}},$(document).ready(function(){var a=new Drawing.SphereGraph({numNodes:50,showStats:!0,showInfo:!0});$.get("/api/get-friends").then(function(b){var c=JSON.parse(b);c=c.data,setInterval(function(){c.length&&a.createGraph(c.pop())},0)}),$(".mutual").on("click",function(){$.get("/api/get-user").then(function(b){friendList=JSON.parse(b).friends;var c=function(b){var d=b.pop(),e={id:d};return $.post("/api/get-mutual",e).then(function(b){console.log("response: ",b);var c=JSON.parse(b),e=function(b){var c=b.pop();return a.addEdge(d,c),b.length?e(b):void 0};c.length&&e(c)}),b.length?c(b):void 0};c(friendList)})}),$(".connect").on("click",function(){$.get("/api/get-user").then(function(b){var c=JSON.parse(b);a.addUser(c,!0)})}),$(".fly").on("click",function(){$.get("/api/get-user").then(function(b){var c,e,f=JSON.parse(b).friends,g=0;setInterval(function(){for(g===f.length&&(g=0),c=f[g],e=a.getNode(c);!e;)g+=1,g===f.length&&(g=0),c=f[g],e=a.getNode(c);a.goToNode(c),FBData.get("newsFeed",c,function(a){a=JSON.parse(a),console.log(a),d(a)}),g+=1},4e3)})}),$(".newsFeed").on("click",function(){FBData.get("newsFeed","me",function(a){a=JSON.parse(a),console.log(a)})});var b=[],c=$('<div class="panel panel-default info-box"><div class="panel-heading info-header"></div><div class="panel-body info-data"></div></div>'),d=function(d){var e=c.clone(),f=e.find(".info-data"),g=e.find(".info-header");if(d.posts)for(var h=d.posts.data,i=Math.min(h.length,2),j=0;i>j;j++){var k=h[j];g.text(k.from.name),k.message&&(f.append("<p>"+k.message+"</p>"),f.append("<p>"+k.created_time+"</p>")),k.picture&&(f.append('<img class="info-img" src="'+k.picture+'"></img>'),f.append("<p>"+k.created_time+"</p>")),k.story&&(f.append("<p>"+k.story+"</p>"),k.link&&f.append('<p><a href="'+k.link+'">Take a Look</a><p>'))}else{var l=a.getCurrent().data.name;g.text(l),f.append("<p>No new updates.</p>")}$(".panel-wrapper").prepend(e),b.push(e),b.length>2&&(b[0].fadeOut("slow"),b.shift())}});var queryStringData={friendsQuery:{queryString:["SELECT uid, name, current_location.latitude, current_location.longitude, pic_square ","FROM user ","WHERE uid in (","SELECT uid2 FROM friend ","WHERE uid1 = me())"],url:"/api/save-friends",endpoint:"/fql"},timelineQuery:{queryString:[],url:"/api/save-timeline"},checkinsQuery:{queryString:["checkins{place,id,from,created_time,message,tags}"],type:"checkins",url:"/api/save-checkins",endpoint:"/me"},mutualFriends:{queryString:["SELECT uid1 FROM friend WHERE uid2=[targetID] AND uid1 IN (SELECT uid2 FROM friend WHERE uid1=me())"],url:"/api/save-mutual",endpoint:"/me"},newsFeed:{queryString:["posts{id,type,from,to,with_tags,created_time,message,story,link,name,tags,picture}"],endpoint:!1}},filter=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].id);return b},FBData=function(){function a(a,c,d){var e,g=f[a];e=g.endpoint?g.endpoint:"/"+c;var h={};"/fql"===e?h.q=g.queryString.join(""):h.fields=g.queryString.join(""),console.log("my query:",e,h),FB.api(e,h,function(a){var c,e;if(a){if("checkins"===g.type&&b(a),e=e||a,c=JSON.stringify(e),!g.url)return d(c);$.post(g.url,{response:c}).then(function(a){console.log("ajax success:",g.url,a)})}})}function b(a){if(a.next){var c=a.next,d=e(a);console.table(d),setTimeout(function(){$.get(c,function(a){console.table("paginated response:",a),b(a)})})}}function c(){$.get("/api/get-friends").then(function(a){console.log(a),a=JSON.parse(a);var b=a.data;$(".friends").text(b.length.toString()),$(".helper").toggle(),$(".title").toggle();var c=0,d=function(a){var b=a.pop(),e=b.fbId;FB.api("/me/mutualfriends/"+e,function(b){var f=filter(b.data),g={userB:e,mutuals:f};$.post("/api/save-mutual",g).then(function(){return c++,$(".done").text(""+c),a.length?d(a):void 0})})};d(b)})}function d(a,b){FB.api("/"+a+"/likes",function(a){b(a)})}function e(a){var b=[];return console.log("fb response",a),arrayOfCheckins=a.checkins?a.checkins.data:[],arrayOfCheckins.forEach(function(a,b){if(a){var c={fbId:a.id,checkin_date:a.data[b].created_time,place:{fbId:a.place.id,name:a.place.name,photo:null}||null,latitude:a.place.latitude,longitude:a.place.longitude,from:{name:a.from.name,fbId:a.from.id}||null,message:a.message||null,clique:a.tags.data||[]};results.push(c)}}),b}var f=queryStringData;return{get:a,getMutual:c,getPostLikes:d}}();!function(a){function b(a){"connected"===a.status?d():document.getElementById("status").innerHTML="not_authorized"===a.status?"Please log into this app.":"Please log into Facebook."}function c(){FB.getLoginStatus(function(a){b(a)})}function d(){console.log("Welcome!  Fetching your information.... "),FB.api("/me",function(a){console.log("Successful login for: "+a.name),document.getElementById("status").innerHTML="Thanks for logging in, "+a.name+"!",console.log("isloggedIn response:",a),FB.api("/fql",{q:"SELECT current_location.latitude, current_location.longitude, first_name, last_name, uid, pic_square FROM user WHERE uid = me()"},function(a){console.log("save user: ",a),$.post("/api/save-user",{user:a.data})})})}a.fbAsyncInit=function(){$.get("/fbconfig").then(function(a){console.log(a),console.log(typeof a),FB.init({appId:a||appConfig.fbId,cookie:!0,xfbml:!0,version:"v1.0"}),setTimeout(function(){c()})})},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk")}(window),$(function(){$("button.query").on("click",function(a){a.preventDefault();var b=a.currentTarget.id;"mutualFriends"===b?FBData.getMutual():FBData.get(b)})});