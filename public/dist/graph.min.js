/*! dataGlobe 2014-09-26 */
function Graph(a){this.options=a||{},this.nodeSet={},this.nodes=[],this.edges=[],this.layout}function Node(a){this.id=a,this.nodesTo=[],this.nodesFrom=[],this.position={},this.data={}}function Edge(a,b){this.source=a,this.target=b,this.data={}}Graph.prototype.addNode=function(a){return void 0!=this.nodeSet[a.id]||this.reached_limit()?!1:(this.nodeSet[a.id]=a,this.nodes.push(a),!0)},Graph.prototype.getNode=function(a){return this.nodeSet[a]},Graph.prototype.addEdge=function(a,b){if(a.addConnectedTo(b)===!0){var c=new Edge(a,b);return this.edges.push(c),!0}return!1},Graph.prototype.reached_limit=function(){return void 0!=this.options.limit?this.options.limit<=this.nodes.length:!1},Node.prototype.addConnectedTo=function(a){return this.connectedTo(a)===!1?(this.nodesTo.push(a),!0):!1},Node.prototype.connectedTo=function(a){for(var b=0;b<this.nodesTo.length;b++){var c=this.nodesTo[b];if(c.id==a.id)return!0}return!1},THREE.Label=function(a,b){function c(){var b=d.getContext("2d"),c="40pt";b.font=c+" Arial";var e=b.measureText(a).width;d.setAttribute("width",e),b.font=c+" Arial",b.textBaseline="top",b.fillText(a,0,0);var f=new THREE.CubeGeometry(e,200,0),g=new THREE.MeshBasicMaterial({map:new THREE.Texture(d),transparent:!0});g.map.needsUpdate=!0;var h=new THREE.Mesh(f,g);return h}var d=document.createElement("canvas");return c()},THREE.ObjectSelection=function(a){function b(a){g.x=a.clientX/window.innerWidth*2-1,g.y=2*-(a.clientY/window.innerHeight)+1}function c(){d.INTERSECTED&&"function"==typeof f&&f(d.INTERSECTED)}var a=a||{};this.domElement=a.domElement||document,this.projector=new THREE.Projector,this.INTERSECTED;var d=this,e=a.selected,f=a.clicked,g={x:0,y:0};this.domElement.addEventListener("mousemove",b,!1),this.domElement.addEventListener("click",c,!1),this.render=function(a,b){var c=new THREE.Vector3(g.x,g.y,.5);this.projector.unprojectVector(c,b);var d=new THREE.Raycaster(b.position,c.sub(b.position).normalize()),f=d.intersectObject(a,!0);f.length>0?this.INTERSECTED!=f[0].object&&(this.INTERSECTED&&this.INTERSECTED.material.color.setHex(this.INTERSECTED.currentHex),this.INTERSECTED=f[0].object,this.INTERSECTED.currentHex=this.INTERSECTED.material.color.getHex(),this.INTERSECTED.material.color.setHex(16711680),"function"==typeof e&&e(this.INTERSECTED)):(this.INTERSECTED&&this.INTERSECTED.material.color.setHex(this.INTERSECTED.currentHex),this.INTERSECTED=null,"function"==typeof e&&e(this.INTERSECTED))}};var Layout=Layout||{};Layout.ForceDirected=function(a,b){var b=b||{};this.layout=b.layout||"2d",this.attraction_multiplier=b.attraction||5,this.repulsion_multiplier=b.repulsion||.75,this.max_iterations=b.iterations||1e3,this.graph=a,this.width=b.width||200,this.height=b.height||200,this.finished=!1;var c,d,e,f,g,h=b.positionUpdated,i=1e-6,j=0,k=0,l=0;this.init=function(){this.finished=!1,k=this.width/10,f=this.graph.nodes.length,g=this.graph.edges.length,e=Math.sqrt(this.height*this.width/f),c=this.attraction_multiplier*e,d=this.repulsion_multiplier*e},this.generate=function(){if(!(j<this.max_iterations&&k>1e-6))return this.finished||console.log("Average time: "+l/j+" ms"),this.finished=!0,!1;for(var b=(new Date).getTime(),e=0;f>e;e++){var m=a.nodes[e];m.layout=m.layout||{},0==e&&(m.layout.offset_x=0,m.layout.offset_y=0,"3d"===this.layout&&(m.layout.offset_z=0)),m.layout.force=0,m.layout.tmp_pos_x=m.layout.tmp_pos_x||m.position.x,m.layout.tmp_pos_y=m.layout.tmp_pos_y||m.position.y,"3d"===this.layout&&(m.layout.tmp_pos_z=m.layout.tmp_pos_z||m.position.z);for(var n=e+1;f>n;n++){var o=a.nodes[n];if(e!=n){o.layout=o.layout||{},o.layout.tmp_pos_x=o.layout.tmp_pos_x||o.position.x,o.layout.tmp_pos_y=o.layout.tmp_pos_y||o.position.y,"3d"===this.layout&&(o.layout.tmp_pos_z=o.layout.tmp_pos_z||o.position.z);var p=m.layout.tmp_pos_x-o.layout.tmp_pos_x,q=m.layout.tmp_pos_y-o.layout.tmp_pos_y;if("3d"===this.layout)var r=m.layout.tmp_pos_z-o.layout.tmp_pos_z;var s=Math.max(i,Math.sqrt(p*p+q*q));if("3d"===this.layout)var t=Math.max(i,Math.sqrt(r*r+q*q));var u=d*d/s;if("3d"===this.layout)var v=d*d/t;m.layout.force+=u,o.layout.force+=u,m.layout.offset_x+=p/s*u,m.layout.offset_y+=q/s*u,0==e&&(o.layout.offset_x=0,o.layout.offset_y=0,"3d"===this.layout&&(o.layout.offset_z=0)),o.layout.offset_x-=p/s*u,o.layout.offset_y-=q/s*u,"3d"===this.layout&&(m.layout.offset_z+=r/t*v,o.layout.offset_z-=r/t*v)}}}for(var e=0;g>e;e++){var w=a.edges[e],p=w.source.layout.tmp_pos_x-w.target.layout.tmp_pos_x,q=w.source.layout.tmp_pos_y-w.target.layout.tmp_pos_y;if("3d"===this.layout)var r=w.source.layout.tmp_pos_z-w.target.layout.tmp_pos_z;var s=Math.max(i,Math.sqrt(p*p+q*q));if("3d"===this.layout)var t=Math.max(i,Math.sqrt(r*r+q*q));var u=s*s/c;if("3d"===this.layout)var v=t*t/c;w.source.layout.force-=u,w.target.layout.force+=u,w.source.layout.offset_x-=p/s*u,w.source.layout.offset_y-=q/s*u,"3d"===this.layout&&(w.source.layout.offset_z-=r/t*v),w.target.layout.offset_x+=p/s*u,w.target.layout.offset_y+=q/s*u,"3d"===this.layout&&(w.target.layout.offset_z+=r/t*v)}for(var e=0;f>e;e++){var x=a.nodes[e],s=Math.max(i,Math.sqrt(x.layout.offset_x*x.layout.offset_x+x.layout.offset_y*x.layout.offset_y));if("3d"===this.layout)var t=Math.max(i,Math.sqrt(x.layout.offset_z*x.layout.offset_z+x.layout.offset_y*x.layout.offset_y));x.layout.tmp_pos_x+=x.layout.offset_x/s*Math.min(s,k),x.layout.tmp_pos_y+=x.layout.offset_y/s*Math.min(s,k),"3d"===this.layout&&(x.layout.tmp_pos_z+=x.layout.offset_z/t*Math.min(t,k));var y=!0;x.position.x-=(x.position.x-x.layout.tmp_pos_x)/10,x.position.y-=(x.position.y-x.layout.tmp_pos_y)/10,"3d"===this.layout&&(x.position.z-=(x.position.z-x.layout.tmp_pos_z)/10),y&&"function"==typeof h&&h(x)}k*=1-j/this.max_iterations,j++;var z=(new Date).getTime();return l+=z-b,!0},this.stop_calculating=function(){j=this.max_iterations}};var Drawing=Drawing||{};Drawing.SimpleGraph=function(a){function b(){if(k=new THREE.WebGLRenderer({alpha:!0}),k.setSize(window.innerWidth,window.innerHeight),h=new THREE.PerspectiveCamera(40,window.innerWidth/window.innerHeight,1,1e6),h.position.z=5e3,i=new THREE.OrbitControls(h),i.addEventListener("change",f),j=new THREE.Scene,l="3d"===q.layout?new THREE.CubeGeometry(25,25,25):new THREE.CubeGeometry(50,50,0),q.selection&&(m=new THREE.ObjectSelection({domElement:k.domElement,selected:function(a){null!=a?n.select="Object "+a.id:delete n.select},clicked:function(){}})),document.body.appendChild(k.domElement),q.show_info){var a=document.createElement("div"),b=document.createAttribute("id");b.nodeValue="graph-info",a.setAttributeNode(b),document.body.appendChild(a)}}function c(a){var b=new THREE.Mesh(l,new THREE.MeshBasicMaterial({color:16777215*Math.random(),opacity:.5}));if(q.show_labels){if(void 0!=a.data.title)var c=new THREE.Label(a.data.title);else var c=new THREE.Label(a.id);a.data.label_object=c,j.add(a.data.label_object)}var d=5e3;b.position.x=Math.floor(Math.random()*(d+d+1)-d),b.position.y=Math.floor(Math.random()*(d+d+1)-d),"3d"===q.layout&&(b.position.z=Math.floor(Math.random()*(d+d+1)-d)),b.id=a.id,a.data.draw_object=b,a.position=b.position,j.add(a.data.draw_object)}function d(a,b){material=new THREE.LineBasicMaterial({color:16711680,opacity:1,linewidth:1.5});var c=new THREE.Geometry;c.vertices.push(a.data.draw_object.position),c.vertices.push(b.data.draw_object.position),line=new THREE.Line(c,material,THREE.LinePieces),line.scale.x=line.scale.y=line.scale.z=1,line.originalScale=1,p.push(c),j.add(line)}function e(){requestAnimationFrame(e),i.update(),f(),q.show_info&&g()}function f(){void 0!==o.layout&&(o.layout.finished?n.calc="":(n.calc="<span style='color: red'>Calculating layout...</span>",o.layout.generate()));for(var a=0;a<p.length;a++)p[a].verticesNeedUpdate=!0;if(q.show_labels)for(var b=o.nodes.length,a=0;b>a;a++){var c=o.nodes[a];if(void 0!=c.data.label_object)c.data.label_object.position.x=c.data.draw_object.position.x,c.data.label_object.position.y=c.data.draw_object.position.y-100,c.data.label_object.position.z=c.data.draw_object.position.z,c.data.label_object.lookAt(h.position);else{if(void 0!=c.data.title)var d=new THREE.Label(c.data.title,c.data.draw_object);else var d=new THREE.Label(c.id,c.data.draw_object);c.data.label_object=d,j.add(c.data.label_object)}}else for(var b=o.nodes.length,a=0;b>a;a++){var c=o.nodes[a];void 0!=c.data.label_object&&(j.remove(c.data.label_object),c.data.label_object=void 0)}q.selection&&m.render(j,h),k.render(j,h)}function g(){var a="";for(var b in n)""!=a&&""!=n[b]&&(a+=" - "),a+=n[b];document.getElementById("graph-info").innerHTML=a}var a=a||{};this.layout=a.layout||"3d",this.layout_options=a.graphLayout||{},this.show_stats=a.showStats||!1,this.show_info=a.showInfo||!1,this.show_labels=a.showLabels||!1,this.selection=a.selection||!1,this.limit=a.limit||10,this.nodes_count=a.numNodes||20,this.edges_count=a.numEdges||10;var h,i,j,k,l,m,n={},o=new Graph({limit:a.limit}),p=[],q=this;b(),e(),this.user,this.insertNode=function(a,b){var e=new Node(a.fbId);return e.position.x=a.latitude,e.position.y=a.longitude,b?(this.user=e,o.addNode(e),c(e)):(o.addNode(e),c(e),o.addEdge(e,this.user)&&d(e,this.user)),void 0===o.layout&&(q.layout_options.width=q.layout_options.width||2e3,q.layout_options.height=q.layout_options.height||2e3,q.layout_options.iterations=q.layout_options.iterations||1e5,q.layout_options.layout=q.layout_options.layout||q.layout,o.layout=new Layout.ForceDirected(o,q.layout_options),n.nodes="Nodes "+o.nodes.length,n.edges="Edges "+o.edges.length,o.layout.init()),e},this.getNode=function(a){return o.getNode(a)},this.addEdge=function(a,b){o.addEdge(a,b)&&d(a,b)},this.stop_calculating=function(){o.layout.stop_calculating()}},$(document).ready(function(){var a=new Drawing.SimpleGraph({numNodes:50,showStats:!1,showInfo:!0});$.get("/api/get-user").then(function(b){{var c=JSON.parse(b);c.friends}console.log("user: ",c),a.createGraph(c,!0),$.get("/api/get-friends").then(function(b){var c=JSON.parse(b);c=c.data,setInterval(function(){c.length&&a.createGraph(c.pop())},500);for(var d={},e=0;e<c.length;e++){var f=c[e];d[f.fbId]=f}FBData.get("newsFeed","me",function(a){JSON.parse(a)})})})});var queryStringData={friendsQuery:{queryString:["SELECT uid, name, current_location.latitude, current_location.longitude, pic_square ","FROM user ","WHERE uid in (","SELECT uid2 FROM friend ","WHERE uid1 = me())"],url:"/api/save-friends",endpoint:"/fql"},timelineQuery:{queryString:[],url:"/api/save-timeline"},checkinsQuery:{queryString:["checkins{place,id,from,created_time,message,tags}"],type:"checkins",url:"/api/save-checkins",endpoint:"/me"},mutualFriends:{queryString:["SELECT uid1 FROM friend WHERE uid2=[targetID] AND uid1 IN (SELECT uid2 FROM friend WHERE uid1=me())"],url:"/api/save-mutual",endpoint:"/me"},newsFeed:{queryString:["posts{id,type,from,to,with_tags,created_time,message,story,link,name,tags,picture}"],endpoint:!1}},filter=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].id);return b},FBData=function(){function a(a,c,d){var e,g=f[a];e=g.endpoint?g.endpoint:"/"+c;var h={};"/fql"===e?h.q=g.queryString.join(""):h.fields=g.queryString.join(""),console.log("my query:",e,h),FB.api(e,h,function(a){var c,e;if(a){if("checkins"===g.type&&b(a),e=e||a,c=JSON.stringify(e),!g.url)return d(c);$.post(g.url,{response:c}).then(function(a){console.log("ajax success:",g.url,a)})}})}function b(a){if(a.next){var c=a.next,d=e(a);console.table(d),setTimeout(function(){$.get(c,function(a){console.table("paginated response:",a),b(a)})})}}function c(){$.get("/api/get-friends").then(function(a){console.log(a),a=JSON.parse(a);var b=a.data;$(".friends").text(b.length.toString()),$(".helper").toggle(),$(".title").toggle();var c=0,d=function(a){var b=a.pop(),e=b.fbId;FB.api("/me/mutualfriends/"+e,function(b){var f=filter(b.data),g={userB:e,mutuals:f};$.post("/api/save-mutual",g).then(function(){return c++,$(".done").text(""+c),a.length?d(a):void 0})})};d(b)})}function d(a,b){FB.api("/"+a+"/likes",function(a){b(a)})}function e(a){var b=[];return console.log("fb response",a),arrayOfCheckins=a.checkins?a.checkins.data:[],arrayOfCheckins.forEach(function(a,b){if(a){var c={fbId:a.id,checkin_date:a.data[b].created_time,place:{fbId:a.place.id,name:a.place.name,photo:null}||null,latitude:a.place.latitude,longitude:a.place.longitude,from:{name:a.from.name,fbId:a.from.id}||null,message:a.message||null,clique:a.tags.data||[]};results.push(c)}}),b}var f=queryStringData;return{get:a,getMutual:c,getPostLikes:d}}();!function(a){function b(a){"connected"===a.status?d():document.getElementById("status").innerHTML="not_authorized"===a.status?"Please log into this app.":"Please log into Facebook."}function c(){FB.getLoginStatus(function(a){b(a)})}function d(){console.log("Welcome!  Fetching your information.... "),FB.api("/me",function(a){console.log("Successful login for: "+a.name),document.getElementById("status").innerHTML="Thanks for logging in, "+a.name+"!",console.log("isloggedIn response:",a),FB.api("/fql",{q:"SELECT current_location.latitude, current_location.longitude, first_name, last_name, uid, pic_square FROM user WHERE uid = me()"},function(a){console.log("save user: ",a),$.post("/api/save-user",{user:a.data})})})}a.fbAsyncInit=function(){$.get("/fbconfig").then(function(a){console.log(a),console.log(typeof a),FB.init({appId:a||appConfig.fbId,cookie:!0,xfbml:!0,version:"v1.0"}),setTimeout(function(){c()})})},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk")}(window);